name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            
            echo "üöÄ Starting deployment..."
            
            # Navigate to project directory
            cd /var/www/crs-trial || {
              echo "‚ùå Project directory not found!"
              exit 1
            }
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            
            # Navigate to docker directory
            cd docker
            
            # Check if .env exists
            if [ ! -f .env ]; then
              echo "‚ùå .env file not found!"
              echo "Please run ./setup-env.sh first"
              exit 1
            fi
            
            # Rebuild and restart containers
            echo "üê≥ Rebuilding containers..."
            docker-compose -f docker-compose.prod.yaml --env-file .env build app
            
            echo "üîÑ Restarting containers..."
            docker-compose -f docker-compose.prod.yaml --env-file .env up -d app
            
            # Wait for container to be ready
            echo "‚è≥ Waiting for container to be ready..."
            sleep 10
            
            # Setup database schema if needed
            echo "üóÑÔ∏è  Setting up database schema..."
            docker exec crs-trial npx prisma@6.1.0 db push || echo "Database schema already up to date"
            
            # Health check
            echo "üè• Running health check..."
            sleep 5
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
            else
              echo "‚ö†Ô∏è  Health check failed, but deployment completed"
            fi
            
            echo "‚úÖ Deployment completed successfully!"
          ENDSSH

      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployment to VPS completed!"
          echo "üåê Application should be available at: ${{ secrets.VPS_URL }}"
