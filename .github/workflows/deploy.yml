name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            
            echo "üöÄ Starting deployment..."
            
            # Navigate to project directory
            cd /var/www/crs-trial || {
              echo "‚ùå Project directory not found!"
              exit 1
            }
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            
            # Navigate to docker directory
            cd docker
            
            # Check if .env exists
            if [ ! -f .env ]; then
              echo "‚ùå .env file not found!"
              echo "Please run ./setup-env.sh first"
              exit 1
            fi
            
            # Ensure PostgreSQL container is running (jangan recreate, pertahankan volume)
            echo "üóÑÔ∏è  Ensuring PostgreSQL container is running..."
            docker-compose -f docker-compose.prod.yaml --env-file .env up -d postgres || {
              echo "‚ö†Ô∏è  PostgreSQL container might already be running"
            }
            
            # Wait for PostgreSQL to be ready
            echo "‚è≥ Waiting for PostgreSQL to be ready..."
            sleep 5
            timeout=30
            # Get POSTGRES_USER from .env or use default
            POSTGRES_USER=$(grep POSTGRES_USER .env | cut -d '=' -f2 | tr -d '"' || echo "postgres")
            while [ $timeout -gt 0 ]; do
              if docker exec crs-trial-db-prod pg_isready -U "$POSTGRES_USER" > /dev/null 2>&1; then
                echo "‚úÖ PostgreSQL is ready!"
                break
              fi
              echo "‚è≥ Waiting for PostgreSQL... ($timeout seconds remaining)"
              sleep 2
              timeout=$((timeout - 2))
            done
            
            # Rebuild and restart app container (jangan rebuild postgres untuk menjaga data)
            echo "üê≥ Rebuilding app container..."
            docker-compose -f docker-compose.prod.yaml --env-file .env build app
            
            echo "üîÑ Restarting app container..."
            docker-compose -f docker-compose.prod.yaml --env-file .env up -d app
            
            # Wait for app container to be ready
            echo "‚è≥ Waiting for app container to be ready..."
            sleep 10
            
            # Setup database schema if needed
            # db push akan UPDATE schema tanpa menghapus data yang sudah ada
            # Default behavior: akan error jika ada perubahan yang bisa menghapus data (AMAN)
            # --skip-generate: skip generate di sini, kita akan generate setelahnya
            echo "üóÑÔ∏è  Updating database schema (data akan dipertahankan)..."
            echo "‚ö†Ô∏è  Note: db push akan error jika ada perubahan destructive (ini AMAN untuk melindungi data)"
            docker exec crs-trial npx prisma@6.1.0 db push --skip-generate || {
              echo "‚ö†Ô∏è  Schema update failed atau ada perubahan yang memerlukan perhatian"
              echo "‚ö†Ô∏è  Data tetap aman - tidak ada data yang dihapus"
              echo "‚ö†Ô∏è  Jika perlu perubahan destructive, gunakan migration manual"
            }
            
            # Generate Prisma Client after schema update (untuk memastikan model baru seperti ApiKey tersedia)
            echo "üîß Generating Prisma Client..."
            docker exec crs-trial npx prisma@6.1.0 generate || {
              echo "‚ö†Ô∏è  Prisma Client generation failed, trying to rebuild container..."
              docker-compose -f docker-compose.prod.yaml --env-file .env build app
              docker-compose -f docker-compose.prod.yaml --env-file .env up -d app
              sleep 5
            }
            
            # Restart container setelah schema update untuk memastikan aplikasi menggunakan Prisma Client terbaru
            echo "üîÑ Restarting container after schema update..."
            docker-compose -f docker-compose.prod.yaml --env-file .env restart app
            sleep 5
            
            # Health check
            echo "üè• Running health check..."
            sleep 5
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
            else
              echo "‚ö†Ô∏è  Health check failed, but deployment completed"
            fi
            
            echo "‚úÖ Deployment completed successfully!"
          ENDSSH

      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployment to VPS completed!"
          echo "üåê Application should be available at: ${{ secrets.VPS_URL }}"
